@page "/register"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Mvc
@using RuralAddress.Core.Entities
@attribute [IgnoreAntiforgeryToken]
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

<div class="row justify-content-center mt-5">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Registrar Novo Usuário (Admin)</div>
            <div class="card-body">
                <form method="post">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Senha</label>
                        <input type="password" name="password" class="form-control" id="passwordInput" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar Senha</label>
                        <input type="password" name="confirmPassword" class="form-control" id="confirmPasswordInput" required />
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="showPasswordCheck" onclick="togglePasswords()">
                        <label class="form-check-label" for="showPasswordCheck">Mostrar senhas</label>
                    </div>

                    <script>
                        function togglePasswords() {
                            var passInput = document.getElementById('passwordInput');
                            var confirmInput = document.getElementById('confirmPasswordInput');
                            var type = document.getElementById('showPasswordCheck').checked ? 'text' : 'password';
                            passInput.type = type;
                            confirmInput.type = type;
                        }
                    </script>
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">@ErrorMessage</div>
                    }
                    <button type="submit" class="btn btn-success w-100">Registrar</button>
                </form>
            </div>
        </div>
    </div>
</div>

@functions {
    public string? ErrorMessage { get; set; }

    [IgnoreAntiforgeryToken]
    public async Task<IActionResult> OnPostAsync(string email, string password, string confirmPassword)
    {
        if (password != confirmPassword)
        {
            ErrorMessage = "As senhas não conferem.";
            return Page();
        }

        try
        {
            var user = new ApplicationUser { UserName = email, Email = email, CreationDate = DateTime.UtcNow };
            var result = await UserManager.CreateAsync(user, password);

            if (result.Succeeded)
            {
                return LocalRedirect("/admin/users");
            }

            foreach (var error in result.Errors)
            {
                ErrorMessage += error.Description + " ";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Erro interno: {ex.Message}";
            if (ex.InnerException != null)
            {
                ErrorMessage += $" | Detalhes: {ex.InnerException.Message}";
            }
        }
        return Page();
    }
}
