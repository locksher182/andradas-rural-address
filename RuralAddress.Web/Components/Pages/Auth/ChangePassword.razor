@page "/change-password"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using RuralAddress.Core.Entities
@using System.ComponentModel.DataAnnotations
@attribute [Authorize]
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Trocar Senha</PageTitle>

<div class="container mt-4">
    <h1>Trocar Senha</h1>
    <hr />

    @if (showWarning)
    {
        <div class="alert alert-warning">
            Por motivos de segurança, você deve alterar sua senha antes de continuar.
        </div>
    }

    @if (showSuccess)
    {
        <div class="alert alert-success">
            Senha alterada com sucesso!
        </div>
    }

    <div class="row">
        <div class="col-md-6">
            <EditForm Model="Input" OnValidSubmit="ChangePasswordAsync" FormName="ChangePasswordForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-3">
                    <label for="currentPassword" class="form-label">Senha Atual</label>
                    <InputText id="currentPassword" type="password" class="form-control" @bind-Value="Input.CurrentPassword" />
                    <ValidationMessage For="() => Input.CurrentPassword" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="newPassword" class="form-label">Nova Senha</label>
                    <InputText id="newPassword" type="password" class="form-control" @bind-Value="Input.NewPassword" />
                    <ValidationMessage For="() => Input.NewPassword" class="text-danger" />
                </div>

                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirmar Nova Senha</label>
                    <InputText id="confirmPassword" type="password" class="form-control" @bind-Value="Input.ConfirmPassword" />
                    <ValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-primary">Alterar Senha</button>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    public class InputModel
    {
        [Required]
        [DataType(DataType.Password)]
        [Display(Name = "Senha Atual")]
        public string CurrentPassword { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "A {0} deve ter pelo menos {2} e no máximo {1} caracteres.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Nova Senha")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirmar Nova Senha")]
        [Compare("NewPassword", ErrorMessage = "A nova senha e a confirmação não coincidem.")]
        public string ConfirmPassword { get; set; } = "";
    }

    private bool showWarning = false;
    private bool showSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user != null && user.MustChangePassword)
        {
            showWarning = true;
        }
    }

    private async Task ChangePasswordAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user == null)
        {
            NavigationManager.NavigateTo("login");
            return;
        }

        var result = await UserManager.ChangePasswordAsync(user, Input.CurrentPassword, Input.NewPassword);

        if (result.Succeeded)
        {
            user.MustChangePassword = false;
            await UserManager.UpdateAsync(user);
            showSuccess = true;
            showWarning = false;
            Input = new InputModel(); // Reset form
            StateHasChanged();
        }
        else
        {
            foreach (var error in result.Errors)
            {
                // Add errors to UI
            }
        }
    }
}
