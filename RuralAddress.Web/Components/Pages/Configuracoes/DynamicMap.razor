@page "/mapa-dinamico"
@using RuralAddress.Core.Entities
@using RuralAddress.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@using System.Collections.Generic
@using System.Linq
@inject IPropriedadeService PropriedadeService
@inject IJSRuntime JS
@attribute [Authorize]
@rendermode InteractiveServer

<style>
    /* Card Container */
    .modern-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border: none;
        padding: 1.5rem;
    }

    /* Inputs & Selects */
    .modern-input {
        background-color: #F8FAFC !important;
        border: 1.5px solid #E2E8F0 !important;
        border-radius: 6px;
        color: #334155;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        padding: 0.5rem 0.75rem;
    }

    .modern-input:focus {
        border-color: #008556 !important; /* Green Focus */
        box-shadow: 0 0 0 3px rgba(0, 133, 86, 0.1);
        outline: none;
    }

    /* Connector Badges (AND/OR) */
    .connector-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0.5rem 0;
    }

    .modern-badge-select {
        background-color: #F1F5F9;
        border: 1px solid #CBD5E1;
        border-radius: 20px; /* Pill shape */
        padding: 0.25rem 0; /* Vertical padding only, horizontal auto */
        width: 80px; /* Fixed width */
        font-size: 0.85rem;
        font-weight: 700;
        color: #475569;
        text-align: center;
        text-align-last: center; /* Crucial for Chrome/Edge select */
        cursor: pointer;
        appearance: none; /* Remove default arrow */
        background-image: none;
    }

    .modern-badge-select:focus {
        border-color: #008556;
        outline: none;
    }

    /* Apply Button */
    .btn-apply {
        background-color: #008556;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: background-color 0.2s;
        box-shadow: 0 4px 6px rgba(0, 133, 86, 0.2);
    }

    .btn-apply:hover {
        background-color: #006c45;
        color: white;
    }

    /* Spacing */
    .filter-row {
        padding: 0.75rem 0;
        border-bottom: 1px dashed #F1F5F9;
    }
    .filter-row:last-child {
        border-bottom: none;
    }
</style>

<PageTitle>Mapa Dinâmico</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-dark">Mapa Dinâmico</h1>
    <a href="/" class="btn btn-secondary">Voltar</a>
</div>

<!-- Filter Section -->
<div class="modern-card mb-4">
    <h5 class="fw-bold mb-4 text-dark"><i class="fa-solid fa-filter me-2"></i>Filtros Avançados</h5>
    
    <div class="filter-container">
        @for (int i = 0; i < Filters.Count; i++)
        {
            var index = i; // local copy for closure
            <div class="row align-items-center g-3 filter-row">
                <div class="col-md-3">
                    <select class="form-select modern-input" @bind="Filters[index].Field">
                        <option value="None">Selecione...</option>
                        <option value="Setor">Setor</option>
                        <option value="Cultura">Cultura</option>
                    </select>
                </div>

                @if (Filters[index].Field != "None")
                {
                    <div class="col-md-3">
                        <select class="form-select modern-input" @bind="Filters[index].Operator">
                            <option value="Equal">Igual a</option>
                            <option value="NotEqual">Diferente de</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        @if (Filters[index].Field == "Setor")
                        {
                            <select class="form-select modern-input" @bind="Filters[index].Value">
                                <option value="">Selecione...</option>
                                <option value="All">Todos os Setores</option>
                                @for (int s = 1; s <= 14; s++)
                                {
                                    <option value="@s.ToString()">Setor @s</option>
                                }
                            </select>
                        }
                        else if (Filters[index].Field == "Cultura")
                        {
                            <select class="form-select modern-input" @bind="Filters[index].Value">
                                <option value="">Selecione...</option>
                                @foreach (var cultura in AvailableCultures)
                                {
                                    <option value="@cultura">@cultura</option>
                                }
                            </select>
                        }
                    </div>
                }
                else 
                {
                    <div class="col-md-6 text-muted small pt-1 ps-3">
                        (Sem filtro aplicado nesta linha)
                    </div>
                }

            </div>

            @if (i < Filters.Count - 1)
            {
                <div class="connector-wrapper">
                    <select class="modern-badge-select" @bind="Connectors[index]">
                        <option value="AND">E</option>
                        <option value="OR">OU</option>
                    </select>
                </div>
            }
        }
    </div>

    <div class="mt-4 text-end">
            <button class="btn-apply" @onclick="ApplyFilters">
                <i class="fa-solid fa-check me-2"></i>Aplicar Filtros
            </button>
    </div>
</div>

<div class="modern-card p-0 overflow-hidden">
    <div id="dynamicMap" style="height: 600px; width: 100%;"></div>
</div>

@code {
    private List<Propriedade> allPropriedades = new();
    private List<string> AvailableCultures = new();

    public class FilterRow
    {
        public string Field { get; set; } = "None";
        public string Operator { get; set; } = "Equal";
        public string Value { get; set; } = "";
    }

    private List<FilterRow> Filters = new List<FilterRow>
    {
        new FilterRow(),
        new FilterRow(),
        new FilterRow()
    };

    // Connectors between 0-1 and 1-2
    private List<string> Connectors = new List<string> { "AND", "AND" };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        try 
        {
            var result = await PropriedadeService.GetAllAsync();
            allPropriedades = result.ToList();
            
            // Extract distinct cultures
            AvailableCultures = allPropriedades
                .SelectMany(p => p.Cultivos)
                .Select(c => c.Cultivo?.Name) // Assuming 'Value' is the name in SystemParameter
                .Where(c => !string.IsNullOrEmpty(c))
                .Distinct()
                .OrderBy(c => c)
                .ToList() ?? new List<string>();

            // Initial Load with all data (or no filters applied)
            await UpdateMap(allPropriedades);
            StateHasChanged();
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
    }

    private async Task ApplyFilters()
    {
        var filteredList = new List<Propriedade>();

        foreach (var p in allPropriedades)
        {
            bool? runningResult = null;

            // Row 0
            if (Filters[0].Field != "None") 
            {
                 runningResult = EvaluateRow(p, Filters[0]);
            }

            // Row 1
            if (Filters[1].Field != "None") 
            {
                 bool val = EvaluateRow(p, Filters[1]);
                 if (runningResult.HasValue) 
                     runningResult = Combine(runningResult.Value, val, Connectors[0]);
                 else
                     runningResult = val;
            }

            // Row 2
            if (Filters[2].Field != "None") 
            {
                 bool val = EvaluateRow(p, Filters[2]);
                 if (runningResult.HasValue) 
                     runningResult = Combine(runningResult.Value, val, Connectors[1]);
                 else
                     runningResult = val;
            }

            // If runningResult is null (no filters active), default to true (show all).
            if (runningResult ?? true) 
            {
                filteredList.Add(p);
            }
        }

        await UpdateMap(filteredList);
    }

    private bool EvaluateRow(Propriedade p, FilterRow filter)
    {
        if (filter.Field == "None") return true; 
        if (string.IsNullOrEmpty(filter.Value)) return true; // Ignore incompletes

        bool match = false;

        if (filter.Field == "Setor")
        {
            if (filter.Value == "All") return true; // Special logic for All Sectors

            if (int.TryParse(filter.Value, out int setorVal))
            {
                match = (p.Setor == setorVal);
            }
        }
        else if (filter.Field == "Cultura")
        {
            // Check if ANY of the crops match
            match = p.Cultivos.Any(c => c.Cultivo != null && 
                                        c.Cultivo.Name.Equals(filter.Value, StringComparison.OrdinalIgnoreCase));
        }

        // Apply Operator
        return (filter.Operator == "Equal") ? match : !match;
    }

    private bool Combine(bool left, bool right, string connector)
    {
        return (connector == "AND") ? (left && right) : (left || right);
    }

    private async Task UpdateMap(List<Propriedade> data)
    {
        var mapData = data.Select(p => new {
            id = p.Id,
            p.NomePropriedade,
            p.Latitude,
            p.Longitude,
            p.Setor,
            nome = p.NomePropriedade,
            primeiraPessoa = p.Pessoas.FirstOrDefault()?.Nome ?? "Sem proprietário"
        }).ToList();

        try 
        {
            await JS.InvokeVoidAsync("dynamicMap.initMap", "dynamicMap", mapData);
        }
        catch(Exception ex)
        {
            Console.WriteLine("JS Error: " + ex.Message);
        }
    }
}
