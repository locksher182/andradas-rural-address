@page "/admin/users"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using RuralAddress.Core.Entities
@using Microsoft.EntityFrameworkCore
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Gerenciar Usuários</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gerenciar Usuários</h1>
        <a href="admin/users/create" class="btn btn-primary">
            <i class="bi bi-person-plus-fill"></i> Novo Usuário
        </a>
    </div>

    @if (users == null)
    {
        <p><em>Carregando...</em></p>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Função</th>
                        <th>Data Criação</th>
                        <th>Último Acesso</th>
                        <th>Troca de Senha</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in users)
                    {
                        <tr>
                            <td>@user.UserName</td>
                            <td>
                                @if (user.Roles.Any())
                                {
                                    @string.Join(", ", user.Roles)
                                }
                                else
                                {
                                    <span class="text-muted">Sem função</span>
                                }
                            </td>
                            <td>@user.CreationDate.ToLocalTime().ToString("dd/MM/yyyy")</td>
                            <td>@(user.LastAccessDate.HasValue ? user.LastAccessDate.Value.ToLocalTime().ToString("dd/MM/yyyy") : "-")</td>
                            <td>
                                @if (user.MustChangePassword)
                                {
                                    <span class="badge bg-warning text-dark">Sim</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Não</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditRole(user)">
                                    <i class="bi bi-pencil"></i> Alterar Função
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => ConfirmDelete(user)" disabled="@(user.UserName == currentUserName)">
                                    <i class="bi bi-trash"></i> Excluir
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (showRoleModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alterar Função do Usuário</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <p>Usuário: <strong>@selectedUser?.UserName</strong></p>
                    <div class="mb-3">
                        <label class="form-label">Selecione a Função:</label>
                        <select class="form-select" @bind="selectedRole">
                            @foreach (var role in availableRoles)
                            {
                                <option value="@role">@role</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveRole">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
    <div class="modal-backdrop fade show"></div>
}

@if (showDeleteModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o usuário <strong>@userToDelete?.UserName</strong>?</p>
                    <p class="text-danger small">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDeleteModal">Cancelar</button>
                    <button type="button" class="btn btn-danger" @onclick="DeleteUser">Excluir</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<UserViewModel>? users;
    private bool showRoleModal = false;
    private UserViewModel? selectedUser;
    private string selectedRole = "Basico";
    private List<string> availableRoles = new();

    private string? currentUserName;
    private bool showDeleteModal = false;
    private UserViewModel? userToDelete;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserName = authState.User.Identity?.Name;

        await LoadUsers();
        availableRoles = await RoleManager.Roles.Select(r => r.Name!).ToListAsync();
    }

    private async Task LoadUsers()
    {
        var appUsers = await UserManager.Users.ToListAsync();
        users = new List<UserViewModel>();

        foreach (var user in appUsers)
        {
            var roles = await UserManager.GetRolesAsync(user);
            users.Add(new UserViewModel
            {
                Id = user.Id,
                Email = user.Email,
                UserName = user.UserName,
                MustChangePassword = user.MustChangePassword,
                CreationDate = user.CreationDate,
                LastAccessDate = user.LastAccessDate,
                Roles = roles.ToList()
            });
        }
    }

    private void EditRole(UserViewModel user)
    {
        selectedUser = user;
        selectedRole = user.Roles.FirstOrDefault() ?? "Basico";
        showRoleModal = true;
    }

    private void CloseModal()
    {
        showRoleModal = false;
        selectedUser = null;
    }

    private async Task SaveRole()
    {
        if (selectedUser != null && !string.IsNullOrEmpty(selectedRole))
        {
            var user = await UserManager.FindByIdAsync(selectedUser.Id);
            if (user != null)
            {
                var currentRoles = await UserManager.GetRolesAsync(user);
                await UserManager.RemoveFromRolesAsync(user, currentRoles);
                await UserManager.AddToRoleAsync(user, selectedRole);
                await LoadUsers();
            }
        }
        CloseModal();
    }

    private void ConfirmDelete(UserViewModel user)
    {
        userToDelete = user;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        userToDelete = null;
    }

    private async Task DeleteUser()
    {
        if (userToDelete != null)
        {
            var user = await UserManager.FindByIdAsync(userToDelete.Id);
            if (user != null)
            {
                await UserManager.DeleteAsync(user);
                await LoadUsers();
            }
        }
        CloseDeleteModal();
    }

    public class UserViewModel
    {
        public string Id { get; set; } = string.Empty;
        public string? Email { get; set; }

        public string? UserName { get; set; }
        public DateTime CreationDate { get; set; }
        public DateTime? LastAccessDate { get; set; }
        public bool MustChangePassword { get; set; }
        public List<string> Roles { get; set; } = new();
    }
}
